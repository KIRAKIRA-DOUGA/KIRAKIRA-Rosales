# KIRAKIRA-Rosales å¼€å‘æ–‡æ¡£

## ä¸€ã€å‰è¨€

KIRAKIRA-Rosalesï¼ˆä¸‹æ–‡ç®€ç§°ï¼šâ€œRosalesâ€ æˆ– â€œåç«¯â€ï¼‰æ˜¯ä¸€ä¸ªåŸºäº Koa æ¡†æ¶çš„ã€RESTful çš„åç«¯ API.

æœ¬æ–‡æ¡£ä¸»è¦å†…å®¹å¦‚ä¸‹ï¼š
1. å¦‚ä½•é’ˆå¯¹ç°æœ‰ä»£ç è¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚
2. ä¸åç«¯ç›¸å…³çš„åŸºç¡€è®¾æ–½çš„çŸ¥è¯†ï¼Œä¾‹å¦‚æ•°æ®åº“ã€æœç´¢å¼•æ“å’Œé›†ç¾¤éƒ¨ç½²ç­‰ã€‚

åœ¨ç¼–å†™æœ¬æ–‡æ¡£æ—¶ï¼Œæˆ‘å‡è®¾æ‚¨å·²ç»å…·æœ‰ä¸€å®šçš„ç¼–ç¨‹çŸ¥è¯†ï¼ŒåŒ…æ‹¬ï¼šæŒæ¡ [JavaScript](https://developer.mozilla.org/docs/Web/JavaScript) & [TypeScript](https://www.typescriptlang.org/) çš„åŸºç¡€è¯­æ³•ã€ç†è§£ [HTTP](https://developer.mozilla.org/docs/Web/HTTP/Overview) å·¥ä½œåŸç†ï¼Œå¹¶ä¸”äº†è§£ [æ•°æ®åº“](https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93) å’Œ [NoSQL](https://zh.wikipedia.org/wiki/NoSQL) æ¦‚å¿µã€‚



### æŠ€æœ¯æ ˆ
åœ¨å¼€å§‹å‰ï¼Œäº†è§£ KIRAKIRA-Rosales åŠå…¶ç›¸å…³åŸºç¡€è®¾æ–½çš„æŠ€æœ¯æ¶æ„æ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚

KIRAKIRA-Rosales ç”± TypeScript ç¼–å†™ã€‚å› ä¸º TypeScript çš„ç±»å‹æ£€æŸ¥èƒ½å¤Ÿå¾ˆå¥½åœ°æé«˜ä»£ç è´¨é‡ã€‚  
å…·ä½“æ¥è¯´ï¼Œåç«¯ä½¿ç”¨äº† Koa.js æ¡†æ¶ï¼ŒKoa.js æ˜¯ä¸€ä¸ª Node.js æ¡†æ¶ï¼Œæä¾›äº†æ›´å¥½çš„å¼‚æ­¥å’Œ HTTP æ”¯æŒã€‚  
åç«¯çš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²åœ¨ AWS çš„ EKS é›†ç¾¤ä¸­ã€‚  
åç«¯ä¾èµ–äºä¸€ä¸ª MongoDB æ•°æ®åº“é›†ç¾¤å’Œä¸€ä¸ª Elasticsearch æœç´¢å¼•æ“é›†ç¾¤ï¼Œå®ƒä»¬åŒæ ·éƒ¨ç½²åœ¨ AWS EKS ä¸­ã€‚

å¯¹äºå­˜å‚¨ï¼ŒMongoDB å’Œ Elasticsearch äº§ç”Ÿçš„æ•°æ®è¢«å­˜å‚¨åœ¨æŒ‚è½½åœ¨ AWS EKS ä¸Šçš„ AWS EBS(Elastic Block Store) å—å­˜å‚¨ä¸­ï¼Œå›¾ç‰‡å’Œè§†é¢‘æ–‡ä»¶åˆ™ç”± Cloudflare çš„ R2ã€Images å’Œ Stream å­˜å‚¨ã€‚

[![](https://img.shields.io/badge/-JavaScript-F7DF1E?style=flat-square&logo=javascript&logoColor=black)](https://tc39.es)
[![](https://img.shields.io/badge/-TypeScript-3178C6?style=flat-square&logo=typescript&logoColor=white)](https://www.typescriptlang.org)
[![](https://img.shields.io/badge/-Node.js-417e38?style=flat-square&logo=Node.js&logoColor=white)](https://nodejs.org)
[![](https://img.shields.io/badge/-Koa-EEEEEE?style=flat-square&logo=Koa&logoColor=black)](https://koajs.com)
[![](https://img.shields.io/badge/-MongoDB-EEEEEE?style=flat-square&logo=MongoDB&logoColor=00ed64)](https://www.mongodb.com)
[![](https://img.shields.io/badge/-Elasticsearch-07a0d7?style=flat-square&logo=Elasticsearch&logoColor=333333)](https://www.elastic.co/elasticsearch)
[![](https://img.shields.io/badge/-Kubernetes-0075e4?style=flat-square&logo=Kubernetes&logoColor=white)](https://kubernetes.io/)
[![](https://img.shields.io/badge/-Cloudflare-f6821f?style=flat-square&logo=Cloudflare&logoColor=white)](https://www.cloudflare.com)

## äºŒã€å®‰è£…å’Œå¯åŠ¨
### 1. å…‹éš†å­˜å‚¨åº“ã€‚
ç¡®ä¿ä½ å®‰è£…äº† [Git](https://git-scm.com/)ï¼Œå¹¶ä¸”æœ‰æƒè®¿é—®æœ¬å­˜å‚¨åº“ã€‚

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å…‹éš†æœ¬å­˜å‚¨åº“
``` shell
# è¯·å°† <some-dir> æ›¿æ¢ä¸ºä½ è®¡ç®—æœºä¸Šçš„ä¸€ä¸ªç›®å½•ã€‚
cd <some-dir>

# å…‹éš†
git clone https://github.com/KIRAKIRA-DOUGA/KIRAKIRA-Rosales.git
```
æˆ–è€…ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å…·æœ‰å›¾å½¢åŒ–ç•Œé¢çš„ GitHub Desktop æˆ–å…¶ä»– Git å…¼å®¹å·¥å…·æ¥å®Œæˆè¿™ä¸€æ­¥éª¤ã€‚

### 2. è®¾ç½®ç¯å¢ƒå˜é‡
> [!IMPORTANT]    
> ä¸‹æ–¹çš„ç¤ºä¾‹ä»£ç ä¸­å¹¶ä¸åŒ…å«å…¨éƒ¨ç¯å¢ƒå˜é‡ï¼Œåœ¨å®é™…ä½¿ç”¨æ—¶å¿…é¡»ä¸ºæ¯ä¸€ä¸ªç¯å¢ƒå˜é‡èµ‹å€¼ã€‚  
> å…¨éƒ¨ç¯å¢ƒå˜é‡åŠå…¶ä½œç”¨è¯·å‚é˜…ï¼š[.env.powershell.temp](https://github.com/KIRAKIRA-DOUGA/KIRAKIRA-Rosales/blob/develop/.env.powershell.temp)ã€‚  
```powershell
# å¯¹äºä¸åŒæ“ä½œç³»ç»Ÿï¼Œè®¾ç½®ç¯å¢ƒå˜é‡çš„æ–¹å¼ä¹Ÿä¸åŒã€‚ä»¥ä¸‹ä¸º Windows PowerShell çš„ç¤ºä¾‹
$env:SERVER_PORT="9999"
$env:SERVER_ENV="dev"
$env:SERVER_ROOT_URL="kirakira.moe"
...
```
åœ¨è®¾ç½®ç¯å¢ƒå˜é‡æ—¶æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·åœ¨ [è®®é¢˜](https://github.com/KIRAKIRA-DOUGA/KIRAKIRA-Rosales/issues) æˆ– [è®¨è®ºåŒº](https://github.com/KIRAKIRA-DOUGA/KIRAKIRA-Rosales/discussions) ä¸­æŸ¥æ‰¾è§£ç­”æˆ–æé—®ã€‚

### 3. å¯åŠ¨åç«¯å¼€å‘æœåŠ¡å™¨
> [!IMPORTANT]    
> ä»¥å¼€å‘æ¨¡å¼å¯åŠ¨æœåŠ¡ä¼šå°†ä»£ç æ‰“åŒ…è‡³é¡¹ç›®æ ¹ç›®å½•çš„ `.kirakira` ç›®å½•å†…ã€‚  
```sh
# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# æˆ–è€…,æ‚¨å¯ä»¥ä»¥çƒ­é‡è½½æ–¹å¼å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev-hot
```
å¦‚æœæ‚¨éœ€è¦ä¿®æ”¹å¼€å‘æœåŠ¡å™¨çš„é»˜è®¤æ‰“åŒ…ä½ç½®ï¼Œéœ€è¦ä¿®æ”¹ package.json æ–‡ä»¶é‡Œ `scripts.start` çš„å€¼ã€‚  
`scripts.start` çš„å€¼æ˜¯ä¸€å¥å¯åŠ¨å‘½ä»¤ï¼Œæ‚¨éœ€è¦å°†è¯¥å‘½ä»¤ä¸­æ‰€æœ‰ `.kirakira` æ›¿æ¢ä¸ºæ‚¨çš„è‡ªå®šä¹‰ç›®å½•ã€‚  
ä¾‹å¦‚ `tsc --noEmitOnError --sourceMap --outDir .foo && node ./.foo/app.js` å°†ä¼šå¯¼è‡´å¼€å‘æœåŠ¡å™¨çš„æ‰“åŒ…ç›®å½•æ”¹ä¸º `.foo`

### 4. æ£€æŸ¥
æˆåŠŸæ‰§è¡Œä»¥ä¸Šå‘½ä»¤åï¼Œæ‚¨åº”è¯¥ä¼šè·å¾—ä¸€ä¸ªç›‘å¬ 9999ï¼ˆæˆ–æ‚¨åœ¨ç¯å¢ƒå˜é‡ä¸­è‡ªå®šä¹‰çš„ï¼‰ç«¯å£çš„ KIRAKIRA-Rosales å¼€å‘æœåŠ¡å™¨ã€‚ğŸ‰  
åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­è¾“å…¥ https://localhost:9999 å³å¯æµ‹è¯•è¿è¡ŒçŠ¶æ€ã€‚å¦‚æœå·²ç»æ­£å¸¸å¯åŠ¨å®Œæ¯•ï¼Œåº”å½“å¯ä»¥çœ‹åˆ° â€œHello Worldâ€ æˆ–ç±»ä¼¼å­—æ ·ã€‚

åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæ‚¨å¯ä»¥ç¼–å†™ã€è´¡çŒ®ä»£ç ï¼Œå‚ä¸ KIRAKIRA é¡¹ç›®å¼€å‘ã€‚  

## ä¸‰ã€å¼€å‘
æœ¬ç« å°†ä¼šå¾ªåºæ¸è¿›åœ°ã€ä»‹ç»å¦‚ä½•å¯¹ KIRAKIRA-Rosales è¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œæ”¹è¿›åŠŸèƒ½ã€‚
### ç†Ÿæ‚‰ç›®å½•ç»“æ„
ä»¥ä¸‹ä¸ºé¡¹ç›®ç›®å½•ç»“æ„ç®€ä»‹
```
â—Œ
â”œ .github - GitHub ç›¸å…³é…ç½®
â”‚  â”” workflows - å­˜æ”¾ Github å·¥ä½œæµ
â”œ .vscode - VSCode ç›¸å…³é…ç½®
â”œ docs - å­˜æ”¾è¯´æ˜æ–‡æ¡£ï¼ˆæœ¬æ–‡æ¡£å°±å­˜æ”¾äºè¯¥ç›®å½•ä¸‹ï¼‰
â”œ old - å­˜æ”¾ä¸èˆå¾—åˆ é™¤çš„æ—§ä»£ç 
â”œ src - å­˜æ”¾æºä»£ç 
â”‚  â”œ cloudflare - å­˜æ”¾äº† Cloudflare ç›¸å…³çš„å…±é€šä»£ç 
â”‚  â”œ common - å­˜æ”¾äº†å…±é€šæ–¹æ³•
â”‚  â”œ controller - controller å±‚ï¼Œç”¨äºå¤„ç†æ¥å—çš„è¯·æ±‚è½½è·æ•°æ®å’Œä¸°å¯Œè¯·æ±‚å“åº”æ•°æ®
â”‚  â”œ dbPool - å­˜æ”¾äº† MongoDB ç›¸å…³çš„å…±é€šä»£ç 
â”‚  â”œ elasticsearchPool - å­˜æ”¾äº† Elasticsearch ç›¸å…³çš„å…±é€šä»£ç 
â”‚  â”œ middleware - å­˜æ”¾äº†æœåŠ¡å™¨ä¸­é—´ä»¶ç›¸å…³ä»£ç 
â”‚  â”œ route - å­˜æ”¾äº†è·¯ç”±ä»£ç 
â”‚  â”œ service - service å±‚ï¼Œç”¨äºå¤„ç†ä¸šåŠ¡é€»è¾‘
â”‚  â”œ ssl - SSL ç›¸å…³é…ç½®
â”‚  â”œ store - å­˜æ”¾äº†â€œçŠ¶æ€ç®¡ç†â€æˆ–â€œè¿è¡Œæ—¶å…¨å±€å˜é‡â€ç›¸å…³ä»£ç 
â”‚  â”œ type - å­˜æ”¾äº†å…±é€šçš„ç±»å‹å®šä¹‰ä»£ç 
â”‚  â”” app.ts - è¯¥æ–‡ä»¶ä¸ºç¨‹åºå…¥å£
â”œ .dockerignore - è¯¥æ–‡ä»¶ç”¨äºé…ç½®æ‰§è¡Œ docker build å‘½ä»¤æ—¶å¿½ç•¥çš„æ–‡ä»¶
â”œ .editorconfig - è¯¥æ–‡ä»¶å®šä¹‰äº†ç¼–ç é£æ ¼
â”œ .env.powershell.temp - è¯¥æ–‡ä»¶æ˜¯ç¯å¢ƒå˜é‡æ¨¡æ¿åŠè¯´æ˜æ–‡æ¡£
â”œ .eslintignore - è¯¥æ–‡ä»¶å®šä¹‰äº† Eslint å¿½ç•¥çš„å†…å®¹
â”œ .eslintrc.cjs - è¯¥æ–‡ä»¶å®šä¹‰äº† ESLint é…ç½®
â”œ .gitattributes - è¯¥æ–‡ä»¶å®šä¹‰äº† Git ç›¸å…³é…ç½®
â”œ .gitignore - è¯¥æ–‡ä»¶å®šä¹‰äº† Git å¿½ç•¥çš„æ–‡ä»¶
â”œ Dockerfile - è¯¥æ–‡ä»¶æè¿°äº†æ„å»º Docker å®¹å™¨é•œåƒçš„è¿‡ç¨‹
â”œ LICENSE - è®¸å¯è¯
â”œ README.md - è¯¥æ–‡ä»¶ä¸ºè‡ªè¿°æ–‡ä»¶
â”œ package-lock.json - è¯¥æ–‡ä»¶å›ºå®šäº† npm install æ˜¯å®‰è£…çš„ä¾èµ–åŒ…çš„ç‰ˆæœ¬
â”œ package.json - è¯¥æ–‡ä»¶å®šä¹‰äº†å…ƒæ•°æ®ã€è„šæœ¬å’Œä¾èµ–åŒ…åˆ—è¡¨
â”œ tsconfig.json - è¯¥æ–‡ä»¶ä¸º TypeScript é…ç½®æ–‡ä»¶
â”” É¹É™ÊŒoÉ”.svg - è¯¥æ–‡ä»¶ä¸ºå°é¢å›¾
```
### ä» Hello World å¼€å§‹
ç¬¬ä¸€ä¸ªç¨‹åºæ€»æ˜¯ä» Hello World å¼€å§‹ï¼ŒKIRAKIRA-Rosales ä¹Ÿä¸ä¾‹å¤–ã€‚

åœ¨ `/src/controller` ç›®å½•ä¸­æœ‰ä¸€ä¸ªåä¸º `HelloWorld.ts` çš„ç‰¹æ®Šæ–‡ä»¶ã€‚  
è¯¥æ–‡ä»¶ä¸­æœ‰ä»¥ä¸‹ä»£ç ï¼š
``` TypeScript
import { koaCtx, koaNext } from '../type/koaTypes.js'

export const helloWorld = async (ctx: koaCtx, next: koaNext): Promise<void> => {
	const something = ctx.query.something
	ctx.body = `Hello World: ${something}`
	await next()
}
```
è®©æˆ‘ä»¬ä¸€è¡Œä¸€è¡Œçš„åˆ†æè¿™æ®µä»£ç ï¼š  
é¦–å…ˆï¼Œç¬¬ä¸€è¡Œ
``` TypeScript
import { koaCtx, koaNext } from '../type/koaTypes.js'
```
å®ƒä» koaTypes.jsï¼ˆkoaTypes.tsï¼‰æ–‡ä»¶ä¸­å¯¼å…¥äº†ä¸¤ä¸ªç±»å‹ï¼ŒkoaCtx å’Œ koaNext
```TypeScript
export type koaCtx = Koa.ParameterizedContext<Koa.DefaultState, Koa.DefaultContext, unknown> & {elasticsearchClient?: Client}
export type koaNext = Koa.Next
```
è¿™ä¸¤ä¸ªç±»å‹æ‰©å±•è‡ª Koa æä¾›çš„ç±»å‹ï¼ŒkoaCtx æ˜¯ç½‘ç»œè¯·æ±‚çš„ä¸Šä¸‹æ–‡ï¼ŒkoaNext æ˜¯ä¸€ä¸ªå¯ä»¥è¢«è°ƒç”¨çš„å¼‚æ­¥æ–¹æ³•ã€‚  
koaCtx ç±»å‹è¦æ±‚å¯¹è±¡åº”å½“åŒ…å«è¯·æ±‚å¤´ã€è¯·æ±‚ä½“ã€å“åº”å¤´ã€å“åº”ä½“ä»¥åŠä¸­é—´ä»¶ä¸ºå…¶æ·»åŠ çš„å…¶ä»–å‚æ•°ã€‚  
koaNext ç±»å‹è¦æ±‚ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œç”¨äºæ‰§è¡Œä¸‹ä¸€ä¸­é—´ä»¶ï¼Œå¦‚æœæ˜¯æœ€åä¸€ä¸ªï¼Œåˆ™å®Œæˆè¯·æ±‚å¹¶å°†å“åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

ç›®å‰ï¼Œæ‚¨ä¸éœ€è¦å®Œå…¨äº†è§£è¿™ä¸¤ä¸ªç±»å‹ï¼Œè®©æˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ã€‚
``` TypeScript
export const helloWorld = async (ctx: koaCtx, next: koaNext): Promise<void> => {...}
```
åœ¨è¿™ä¸€è¡Œï¼Œæˆ‘ä»¬å¯¼å‡ºäº†ä¸€ä¸ªåä¸º `helloWorld` çš„å¼‚æ­¥ç®­å¤´å‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š`ctx: koaCtx` å’Œ `next: koaNext`, å¹¶è¿”å›ä¸€ä¸ªç©ºçš„ Promise.  
ctx æ˜¯ context çš„ç¼©å†™ï¼Œä»£è¡¨ä¸Šä¸‹æ–‡ï¼Œå…¶ç±»å‹ koaCtx è¯´æ˜è§ä¸Šæ–‡ã€‚  
next çš„ç±»å‹æ˜¯ koaNextï¼Œè¯´æ˜è§ä¸Šæ–‡ã€‚

æ¥ä¸‹æ¥çš„ä¸¤è¡Œä»£ç ï¼š
``` TypeScript
const something = ctx.query.something
ctx.body = something ? `Hello ${something} World` : 'Hello World'
```
è¿™ä¸€éƒ¨åˆ†ç”¨æ¥å­˜å–ç½‘ç»œè¯·æ±‚ä¸Šä¸‹æ–‡ä¸­çš„æ ‡å¤´æˆ– bodyï¼ˆæ­£æ–‡ï¼‰ã€‚  
é¦–å…ˆï¼Œä» `ctx` ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­åŒ¹é…ç½‘ç»œè¯·æ±‚ä¸­åä¸º `something` çš„â€œæŸ¥è¯¢â€å‚æ•°ï¼Œå¹¶èµ‹å€¼ç»™ `something` å¸¸é‡ã€‚  
ç´§æ¥ç€æ˜¯ä¸€ä¸ªä¸‰å…ƒè¡¨è¾¾å¼ï¼Œæ‚¨å¯ä»¥å°†è¿™ä¸ªè¿ç®—éƒ¨åˆ†ç†è§£ä¸ºâ€œä¸šåŠ¡é€»è¾‘ä»£ç â€ã€‚å¦‚æœ `something` ä¸æ˜¯å‡å€¼ï¼Œåˆ™å°†å…¶ä¸ "Hello World" å­—ç¬¦ä¸²æ‹¼æ¥çš„ç»“æœä½œä¸ºä¸‰å…ƒè¡¨è¾¾å¼çš„è¿ç®—ç»“æœï¼Œå¦‚æœæ˜¯å‡å€¼ï¼Œåˆ™ç›´æ¥å°† 'Hello World' å­—ç¬¦ä¸²ä½œä¸ºä¸‰å…ƒè¡¨è¾¾å¼çš„è¿ç®—ç»“æœã€‚æœ€åï¼Œå°†è¿ç®—ç»“æœèµ‹å€¼åˆ° `ctx` è¯·æ±‚ä¸Šä¸‹æ–‡å¯¹è±¡çš„å“åº”ä½“ä¸­ã€‚

æœ€åä¸€è¡Œä»£ç ï¼š
``` TypeScript
await next()
```
ç­‰å¾…ä¸‹ä¸€ä¸ªä¸­é—´ä»¶æ‰§è¡Œå®Œæˆï¼Œå¦‚æœæ²¡æœ‰ä¸‹ä¸€ä¸ªï¼Œåˆ™å®Œæˆè¯·æ±‚å¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

ä»¥ä¸Šä¾¿æ˜¯ KIRAKIRA-Rosales é€šè¿‡ Koa å“åº”ä¸€ä¸ªç½‘ç»œè¯·æ±‚çš„æœ€ç®€å•çš„æµç¨‹ã€‚  
æ‰“å¼€æ‚¨çš„æµè§ˆå™¨ï¼Œåœ¨åœ°å€æ è¾“å…¥`https://localhost:9999?something=Beautiful` åå›è½¦ï¼Œæ‚¨å°†ä¼šåœ¨é¡µé¢ä¸­çœ‹åˆ° `Hello Beautiful World` å­—æ ·ã€‚ğŸ‰


### è·¯ç”±
ä¸å‰ç«¯çš„è·¯ç”±ç±»ä¼¼ï¼Œåç«¯ä¹Ÿå­˜åœ¨â€œè·¯ç”±â€çš„æ¦‚å¿µã€‚  
å‰ç«¯é€šè¿‡è·¯ç”±åŒ¹é…åˆ°æ­£ç¡®çš„ç»„ä»¶å¹¶æ¸²æŸ“ï¼Œè€Œåç«¯é€šè¿‡è·¯ç”±å°†ç½‘ç»œè¯·æ±‚å‘é€ï¼ˆæ˜ å°„ï¼‰åˆ°æ­£ç¡®çš„ Controller å±‚å¹¶æ‰§è¡Œã€‚  
æ–‡ä»¶ `src\route\router.ts`  å°±æ˜¯æˆ‘ä»¬ç¼–å†™ä» URL åˆ° TypeScript Controller å‡½æ•°çš„æ˜ å°„çš„åœ°æ–¹ã€‚  

ä¸€ä¸ªå…¸å‹çš„ GET è¯·æ±‚è·¯ç”±çœ‹èµ·æ¥åƒï¼š
``` typescript
//      è¯·æ±‚çš„ URL  
//          â†“
router.get(URL, controller)
//                   â†‘
//      è¿™ä¸ª URL å¯¹åº”çš„ Controller å‡½æ•°
```
å¦‚æœæ˜¯ POST è¯·æ±‚ï¼Œåˆ™éœ€è¦å°† `router.get` æ”¹ä¸º `router.post`
``` typescript
//      è¯·æ±‚çš„ URL  
//          â†“
router.post(URL, controller)
//                   â†‘
//      è¿™ä¸ª URL å¯¹åº”çš„ Controller å‡½æ•°
```
ä»¥æ­¤ç±»æ¨ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™å…¶ä»–ç±»å‹çš„è¯·æ±‚ï¼Œä¾‹å¦‚ PUT è¯·æ±‚æˆ– DELETE è¯·æ±‚
```
router.put(URL, controller)
router.delete(URL, controller)
...
```
> [!IMPORTANT]    
> ä¼ å…¥çš„ controller åº”ä¸º TypeScript Controller å‡½æ•°æœ¬èº«ï¼Œè€Œéå‡½æ•°çš„è°ƒç”¨ï¼ˆç»“æœï¼‰ã€‚  
> è§¦å‘ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œkoa-router ä¼šè‡ªåŠ¨å°† (ctx: koaCtx, next: koaNext) ä¼ å…¥åˆ° TypeScript Controller å‡½æ•°ä¸­ã€‚  
``` typescript
router.get(URL, controller) // æ­£ç¡®ç”¨æ³•

router.get(URL, controller()) // âŒ é”™è¯¯ç”¨æ³•
```

### è¯·æ±‚å‚æ•°ï¼ˆè½½è·ï¼‰å’Œè¿”å›ç»“æœ
åœ¨å‘é€è¯·æ±‚æ—¶ï¼Œæœ‰æ—¶æˆ‘ä»¬éœ€è¦æºå¸¦æ•°æ®ï¼ˆè¢«ç§°ä¸ºâ€œè¯·æ±‚å‚æ•°â€æˆ–â€œè¯·æ±‚è½½è·â€ï¼‰ç»™åç«¯ã€‚å½“åç«¯çš„ç¨‹åºæ‰§è¡Œç»“æŸåï¼Œåº”å½“å°†æ‰§è¡Œç»“æœè¿”å›ç»™è¯·æ±‚è€…ã€‚    
ä¾‹å¦‚ï¼Œç”¨æˆ·ç™»å½•æ—¶éœ€è¦å°†ç”¨æˆ·è¾“å…¥çš„é‚®ç®±å’Œå¯†ç å‘é€ç»™åç«¯æ‰§è¡ŒéªŒè¯ï¼Œå¦‚æœéªŒè¯é€šè¿‡ï¼Œåˆ™å°†ç”¨æˆ· Token è¿”å›ç»™å®¢æˆ·ç«¯ã€‚  

åœ¨ä¼ é€’æ•°æ®æ—¶ï¼Œå¯ä»¥é€‰æ‹©â€œæ˜¾å¼â€çš„ä¼ é€’ï¼Œä¹Ÿå¯ä»¥â€œéšå¼â€çš„ä¼ é€’ã€‚  

#### â€œæ˜¾å¼â€ä¼ é€’è¯·æ±‚å‚æ•°ï¼ˆè½½è·ï¼‰
HTTP è¯·æ±‚çš„ URL ä¸­å¯ä»¥ä¼ é€’æ•°æ®ã€‚  
ä½¿ç”¨ URL ä¼ é€’æ•°æ®æ—¶ï¼Œæœ¬é¡¹ç›®å€¾å‘äºä½¿ç”¨ [Parameters (å‚æ•°)](https://developer.mozilla.org/en-US/docs/Learn/Common_questions/Web_mechanics/What_is_a_URL#parameters) è€Œä¸æ˜¯ [Path (è·¯å¾„)](https://developer.mozilla.org/en-US/docs/Learn/Common_questions/Web_mechanics/What_is_a_URL#path_to_resource)ï¼Œå› ä¸º Path éœ€è¦åŠ¨æ€è·¯ç”±åŒ¹é…ã€‚  
``` shell
# ä½¿ç”¨ curl å‘½ä»¤å‘ä¸€ä¸ªå¸¦æœ‰ Parameters çš„ URL å‘é€ GET è¯·æ±‚
curl https://localhost:9999?something=Beautiful
```

> [!IMPORTANT]   
> URL ä¸å®œè¿‡é•¿ï¼Œä¼ é€’çš„æ•°æ®é•¿åº¦æœ‰é™ï¼Œä¸€èˆ¬ç”¨äºè¯·æ±‚æŸäº›æ•°æ®æ—¶ä¼ é€’ç®€å•çš„æŸ¥è¯¢å‚æ•°ã€‚ 

åœ¨åç«¯ TypeScript Controller å‡½æ•°ä¸­ï¼Œä½ å¯ä»¥ä» ctx å¯¹è±¡ä¸­è·å– something æ‰€å¯¹åº”çš„å€¼
``` typescript
const something = ctx.query.something
```
> [!IMPORTANT]    
> something çš„ç±»å‹ä¸º string | string[], å› ä¸º URL Parameters ä¼šå°†é‡åçš„å¤šä¸ªå‚æ•°åˆå¹¶ä¸ºä¸€ä¸ªæ•°ç»„ã€‚  
> åœ¨ç»§ç»­ä¹‹å‰ï¼Œä½ éœ€è¦åˆ¤æ–­æ˜¯å¦æ˜¯æ•°ç»„ï¼ˆæ¨èï¼‰æˆ–æ ¹æ®æ‚¨çš„éœ€æ±‚å°†å…¶æ–­è¨€ï¼Œç„¶åæ‰§è¡Œè¿›ä¸€æ­¥çš„æ•°æ®æ ¡éªŒã€‚  


é™¤äº† URL çš„ Parameters ä¹‹å¤–ï¼Œè¿˜å¯ä»¥åœ¨ HTTP è¯·æ±‚çš„è¯·æ±‚ä½“ä¸­ä¼ é€’æ•°æ®ã€‚  
> [!IMPORTANT]    
> æŸäº› HTTP åè®®çš„å®ç°ä¸æ”¯æŒæŸäº›è¯·æ±‚æ–¹æ³•ï¼ˆä¾‹å¦‚ GET è¯·æ±‚ï¼‰åŒ…å«è¯·æ±‚ä½“ï¼Œè¯¦æƒ…è¯·å‚è€ƒ [MDN ä¸Šçš„ HTTP å‚è€ƒæ–‡æ¡£](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods)   
> è¯·æ±‚ä½“ä¸­å¯ä»¥æºå¸¦è¾ƒå¤šæ•°æ®ï¼Œä½†ä¹Ÿå¹¶éæ— é™åˆ¶ï¼Œä¸Šé™å–å†³äºä¸åŒçš„ HTTP å®ç°ã€‚  

``` shell
# ä½¿ç”¨ curl å‘½ä»¤å‘ä¸€ä¸ª URL å‘é€å¸¦æœ‰è¯·æ±‚ä½“çš„ POST è¯·æ±‚
curl -d "param1=value1&param2=value2" -X POST https://localhost:9999/xxxxx
```
åœ¨åç«¯ TypeScript Controller å‡½æ•°ä¸­ï¼Œä½ å¯ä»¥ä» ctx å¯¹è±¡ä¸­è·å–è¯·æ±‚ä½“æ•°æ®
``` typescript
const data = ctx.request.body as { param1: string; param2: string }
```
> [!IMPORTANT]     
> åœ¨ç»§ç»­ä¹‹å‰ï¼Œæ‚¨éœ€è¦å°†å…¶æ–­è¨€ä¸ºä¸å‘é€è¯·æ±‚æ—¶ä¼ é€’çš„æ•°æ®ç±»å‹ä¸€è‡´çš„ç±»å‹ï¼Œç„¶åæ‰§è¡Œè¿›ä¸€æ­¥çš„æ•°æ®æ ¡éªŒã€‚  

#### â€œéšå¼â€ä¼ é€’æ•°æ®

æ‚¨å¯ä»¥ä½¿ç”¨ [HTTP Cookie](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies) â€œéšå¼â€çš„ä¼ é€’æ•°æ®ã€‚æ¯æ¬¡å‘é€è¯·æ±‚æ—¶ï¼ŒCookie ä¹Ÿä¼šè¢«å‘é€ç»™åç«¯ã€‚  
KIRAKIRA é¡¹ç›®å¤§é‡ä½¿ç”¨ Cookie æ¥å­˜å‚¨ç”¨æˆ· Token, ç”¨æˆ·è®¾ç½®å’Œç”¨æˆ·æ ·å¼ç­‰æ•°æ®ã€‚åœ¨è®¾ç½®åŠå‘é€ Cookie æ—¶éœ€è¦æŒæ¡å…¶é™åˆ¶åŠæŠ€å·§ï¼Œæœ¬æ–‡æ¡£å†…ä¸è¯¦ç»†ä»‹ç»ï¼Œè¯·è‡ªè¡Œå‚é˜… [MDN HTTP Cookie](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies) æ–‡æ¡£ï¼Œä½†æœ‰å‡ ç‚¹æœ‰å¿…è¦è¯´æ˜ï¼š  
* Cookie å¯ä»¥è¢«é™åˆ¶ä»…é™ HTTPS
* HttpOnly çš„ Cookie åªèƒ½é€šè¿‡è¯·æ±‚çš„ set-cookie è®¾ç½®/åˆ é™¤ï¼Œä¸èƒ½é€šè¿‡ JavaScript è®¿é—®
* ç›®å‰å¾ˆå¤šæµè§ˆå™¨ä»…æ”¯æŒç¬¬ä¸€æ–¹ï¼ˆåŒç«™ç‚¹ï¼‰ Cookieï¼Œå³ `SameSite=Strict`ã€‚
* fetch æ–¹æ³•ä½¿ç”¨ { credentials: "include" } é€‰é¡¹å¯ä»¥å…è®¸åœ¨å‘é€è·¨æºè¯·æ±‚æ—¶åŒ…å« Cookie

åœ¨åç«¯ TypeScript Controller å‡½æ•°ä¸­ï¼Œä½ å¯ä»¥ä» ctx å¯¹è±¡ä¸­è·å– Cookie æ•°æ®
``` typescript
ctx.cookies.get(cookieKey) // è·å–åå­—ä¸º cookieKey çš„ Cookie å¯¹åº”çš„å€¼ã€‚
```
> [!IMPORTANT]     
> åœ¨ç»§ç»­ä¹‹å‰ï¼Œä¸è¦å¿˜äº†æ‰§è¡Œè¿›ä¸€æ­¥çš„æ•°æ®æ ¡éªŒã€‚  

#### ä»æœåŠ¡ç«¯è¿”å›ç»“æœåˆ°å®¢æˆ·ç«¯
åœ¨åç«¯é€»è¾‘æ‰§è¡Œå®Œæˆä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚

å°†ç»“æœèµ‹å€¼ç»™ ctx å¯¹è±¡çš„ body å±æ€§ï¼Œç„¶åæ‰§è¡Œä¸‹ä¸€æ­¥ä¸­é—´ä»¶ï¼Œå¦‚æœæ˜¯æœ€åä¸€ä¸ªä¸­é—´ä»¶ï¼Œåˆ™å°† body ä¸­çš„å€¼è¿”å›ç»™å®¢æˆ·ç«¯ã€‚
``` typescript
ctx.body = results
await next() // å‡è®¾å·²ç»æ˜¯æœ€åä¸€ä¸ªä¸­é—´ä»¶
```

### è®¿é—® MongoDB æ•°æ®åº“å’Œ Elasticsearch æœç´¢å¼•æ“
ç”¨æˆ·äº§ç”Ÿçš„æ•°æ®é€šå¸¸ä¼šå­˜å‚¨åˆ° MongoDB ä¸­ï¼Œè€Œéœ€è¦èƒ½å¤Ÿè¢«æœç´¢çš„æ•°æ®ä¼šå­˜å‚¨åˆ° Elasticsearch æœç´¢å¼•æ“ä¸­ã€‚  
å¯¹æ•°æ®åº“å’Œæœç´¢å¼•æ“çš„å¢åˆ æ”¹æŸ¥æ˜¯åç«¯ä»£ç çš„ä¸»è¦åŠŸèƒ½ã€‚

#### MongoDB
åç«¯ä½¿ç”¨ Mongoose è¿æ¥ MongoDB æ•°æ®åº“ã€‚

åœ¨ç¨‹åºåˆå§‹åŒ–æ—¶ï¼Œä¼šç«‹å³æ‰§è¡Œ `src\dbPool\DbClusterPool.ts` æ–‡ä»¶ä¸­çš„ `connectMongoDBCluster` å‡½æ•°ï¼Œè¯¥å‡½æ•°é¦–å…ˆä¼šè¯»å–ç¯å¢ƒå˜é‡ä¸­çš„è¿æ¥å­—ç¬¦ä¸²å’Œæ•°æ®åº“è´¦å·å¯†ç ï¼Œç„¶ååˆ›å»ºæ•°æ®åº“è¿æ¥æ± ã€‚åˆ›å»ºçš„è¿æ¥æ± æ˜¯åœ¨ Mongoose å†…éƒ¨ç»´æŠ¤çš„ï¼ŒMongoose æš´éœ²ä¸€ä¸ª `mongoose` å®ä¾‹ç”¨æ¥æ‰§è¡Œæ•°æ®åº“å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œç”¨æˆ·æ— éœ€å…³å¿ƒè¿æ¥æ± çš„å…·ä½“å®ç°åŠè´Ÿè½½å‡è¡¡ç­‰é—®é¢˜ã€‚

> [!IMPORTANT]     
> å¯¹äºå‰¯æœ¬é›†ï¼Œå†™æ“ä½œæ€»æ˜¯å‘ä¸»åˆ†ç‰‡æäº¤ï¼Œéšåå†ç”±ä¸»åˆ†ç‰‡åŒæ­¥è‡³å‰¯æœ¬åˆ†ç‰‡ã€‚  
> è€Œè¯»æ“ä½œåå¥½åˆ™ç”±ç”¨æˆ·è®¾ç½®ï¼Œæœ¬ç¨‹åºé»˜è®¤çš„æ•°æ®åº“è¯»åå¥½ä¸ºä¼˜å…ˆä»å‰¯æœ¬ä¸­è¯»å–ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ä¼šè¦†ç›–è¿™ä¸ªè®¾ç½®ï¼Œæ¯”å¦‚è¯´ä½¿ç”¨äº‹åŠ¡æ—¶ä¼šä¼˜å…ˆä»ä¸»è¯»å–ã€‚

ä½¿ç”¨ Mongoose æš´éœ²çš„ `mongoose` å®ä¾‹ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥æ‰§è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œï¼Œæœ¬é¡¹ç›®åœ¨ `src\dbPool\DbClusterPool.ts` æ–‡ä»¶ä¸­ä¹Ÿå°è£…äº†å¸¦æœ‰ç±»å‹çº¦æŸçš„ä¾¿æ·å‡½æ•°æ¥æ‰§è¡Œè¿™äº›æ“ä½œã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•å®ä¾‹
``` typescript
import mongoose, { InferSchemaType } from 'mongoose'

/**
 * ç”¨æˆ·æ•°æ®
 */
class UserSchemaFactory {
	schema = {
		uid: { type: Number, unique: true, required: true }, // ç”¨æˆ·çš„ UID
		username: { type: String }, // ç”¨æˆ·å
		editDateTime: { type: Number, required: true }, // ç³»ç»Ÿä¸“ç”¨å­—æ®µ-æœ€åç¼–è¾‘æ—¶é—´
	}
	collectionName = 'user' // MongoDB é›†åˆå
	schemaInstance = new Schema(this.schema) // Mongoose Schema å®ä¾‹
}

const UserSchema =  new UserSchemaFactory() // å®ä¾‹åŒ–
const { collectionName, schemaInstance } = UserSchema // è§£æ„å‡ºé›†åˆåå’Œé›†åˆ Schema å®ä¾‹

type User = InferSchemaType<typeof schemaInstance> // ä½¿ç”¨ InferSchemaType æ¨åˆ°å‡ºç”¨æˆ·æ•°æ®çš„ TypeScript ç±»å‹

const user: User = { // æ„å»ºç”¨æˆ·æ•°æ®
	uid: 1,
	username: 'foo',
	editDateTime: new Date().getTime(),
}

try {
	await insertData2MongoDB<User>(user, schemaInstance, collectionName) // æ’å…¥æ•°æ®
} catch(error) {
	console.error('ERROR', "æ’å…¥æ•°æ®å‡ºé”™ï¼š", error)
}


const userWhere: QueryType<User> = { uid: 1 } // æŸ¥è¯¢ UID ä¸º 1 çš„ç”¨æˆ·æ•°æ®
const userSelect: SelectType<User> = { username: 1 } // åªæŸ¥è¯¢ username å­—æ®µ
try {
	const userResult = await selectDataFromMongoDB<User>(userWhere, userSelect, schemaInstance, collectionName) // æŸ¥è¯¢æ•°æ®
	console.oog('RESULT', useResult)
} catch (error) {
	console.error('ERROR', "æŸ¥è¯¢æ•°æ®å‡ºé”™ï¼š", error)
}
```
> [!IMPORTANT]     
> UserSchemaFactory å’Œ UserSchema é€šå¸¸æ˜¯å•ç‹¬å­˜æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œç„¶åå°† UserSchema å¯¼å‡ºå¹¶åœ¨å…¶ä»–æ–‡ä»¶ä¸­ä½¿ç”¨ã€‚


#### Elasticsearch
Elasticsearch æ˜¯ä¸€ä¸ªæœç´¢å¼•æ“ï¼Œéƒ¨ç½²åœ¨ AWS EKS ä¸Šçš„ Elasticsearch é›†ç¾¤éœ€è¦é€šè¿‡ HTTP è¯·æ±‚æ¥æ“ä½œã€‚  
å®˜æ–¹æä¾›äº† SDK æ¥æ–¹ä¾¿ Node.js ç¨‹åºæ“ä½œ Elasticsearch è€Œæ— éœ€æ‰‹åŠ¨æ„å»º HTTP è¯·æ±‚ã€‚

åŒæ ·çš„ï¼Œç¨‹åºåœ¨åˆå§‹åŒ–æ—¶ä¼šæ‰§è¡Œ `src\elasticsearchPool\elasticsearchClusterPool.ts` æ–‡ä»¶ä¸­çš„ `connectElasticSearchCluster` å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šè¯»å–ç¯å¢ƒå˜é‡ï¼Œç„¶ååˆ›å»ºä¸ Elasticsearch é›†ç¾¤çš„è¿æ¥ã€‚åœ¨åˆ›å»ºè¿æ¥åï¼Œè¿æ¥å®¢æˆ·ç«¯å®ä¾‹ä¼šè¢«æ·»åŠ è‡³ Koa çš„è¯·æ±‚ä¸Šä¸‹æ–‡ ctx ä¸­ã€‚åœ¨ Controller ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ `ctx.elasticsearchClient` è·å–è¿æ¥å®¢æˆ·ç«¯ï¼Œç„¶åæ‰§è¡Œâ€å¢åˆ æ”¹æŸ¥â€œæ“ä½œï¼Œæœ¬é¡¹ç›®åœ¨ `src\elasticsearchPool\elasticsearchClusterPool.ts` æ–‡ä»¶ä¸­ä¹Ÿå°è£…äº†å¸¦æœ‰ç±»å‹çº¦æŸçš„ä¾¿æ·å‡½æ•°æ¥æ‰§è¡Œè¿™äº›æ“ä½œã€‚  

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ã€‚
``` typescript
import { EsSchema2TsType } from '../elasticsearchPool/ElasticsearchClusterPoolTypes.js'


const esClient = ctx.elasticsearchClient // å‡è®¾å·²ç»æ­£ç¡®åˆ›å»ºäº†è¿æ¥

/**
 * è§†é¢‘æ•°æ®
 */
const VideoDocument = {
	schema: {
		title: { type: String, required: true as const }, // è§†é¢‘æ ‡é¢˜
		kvid: { type: Number, required: true as const }, // KVID è§†é¢‘ ID
	},
	indexName: 'search-kirakira-video-elasticsearch', // Elasticsearch ç´¢å¼•å
}

const { indexName: esIndexName, schema: videoEsSchema } = VideoDocument // è§£æ„

const videoEsData: EsSchema2TsType<typeof videoEsSchema> = { // æ„é€ è§†é¢‘æ•°æ®
	title: "foo bar baz",
	kvid: 1,
}
try {
	const refreshFlag = true // æ˜¯å¦ç«‹å³åˆ·æ–°ç´¢å¼•ï¼ˆåˆ·æ–°åè¯¥æ•°æ®æ–¹èƒ½æœç´¢ï¼Œå¦‚æœåˆ·æ–°è¿‡äºé¢‘ç¹ï¼Œå¯èƒ½ä¼šå½±å“æ€§èƒ½ï¼‰
	await insertData2ElasticsearchCluster(esClient, esIndexName, videoEsSchema, videoEsData, refreshFlag) // æ’å…¥æ•°æ®
} catch (error) {
	console.error("ERROR", "ç´¢å¼•æ•°æ®å‡ºé”™ï¼š"ï¼Œerror)
}

const esQuery = { // æ„é€ æœç´¢æ¡ä»¶
	query_string: {
		query: 'foo',
	},
}

try {
	const esSearchResult = await searchDataFromElasticsearchCluster(esClient, esIndexName, videoEsSchema, esQuery) // å¼€å§‹æœç´¢æ•°æ®
	console.log('RESULT', esSearchResult)
} catch (error) {
	console.error("ERROR", "æœç´¢æ•°æ®å‡ºé”™ï¼š"ï¼Œerror)
}


```

TODO
